name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install dependencies
      run: |
        cd frontend
        npm install
        
    - name: Build
      run: |
        cd frontend
        npm run build
        
        # ✅ Crée un 404.html personnalisé pour GitHub Pages SPA
        cat > dist/404.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>Matcha - Redirection</title>
            <script type="text/javascript">
                // Redirection SPA pour GitHub Pages
                var segmentCount = 0;
                var l = window.location;
                l.replace(
                    l.protocol + '//' + l.hostname + (l.port ? ':' + l.port : '') +
                    '/Matcha/' +
                    (segmentCount ? '../'.repeat(segmentCount - 1) : '') +
                    '?p=/' +
                    l.pathname.replace(/^\//, '').replace(/\\//g, '/').replace(/\/$/, '') +
                    (l.search ? '&q=' + l.search.slice(1).replace(/&/g, '~and~') : '') +
                    l.hash
                );
            </script>
        </head>
        <body>
            <p>Redirection vers Matcha...</p>
        </body>
        </html>
        EOF
        
        # ✅ Crée .nojekyll
        touch dist/.nojekyll
      
    - name: Setup Pages
      uses: actions/configure-pages@v2
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v1
      with:
        path: './frontend/dist'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v1